<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" th:href="@{/lib/editor.md/css/editormd.css}">
    <link rel="stylesheet" th:href="@{/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/font.css}">
    <link rel="stylesheet" th:href="@{/css/article.css}">
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/lib/editor.md/editormd.js}"></script>
    <script th:src="@{/lib/layui/layui.js}"></script>

    <!--	引入Vue + Axios    -->
    <script th:src="@{/lib/vue-2.6.14.js}"></script>
    <script th:src="@{/lib/axios-0.21.1.js}"></script>

    <title>查看文章</title>
</head>
<body>
<!--导航栏-->

<!-- 顶部导航栏 -->
<nav class="clearfix">
    <ul id="top-nav-bar" class="layui-nav" layui-filter="top-nav">
        <a href="./index.html"><img th:src="@{/images/logo.png}"
                                    alt="Jancoyan" style="width: 210px;height: 65px"></a>
        <li class="layui-nav-item layui-this">
            <a href="./index.html">文章</a>
        </li>
        <li id="user-profile" class="layui-nav-item" lay-unselect="">
            <a th:href="@{/workbench}">
                <img th:src="@{/images/login-profile.png}" class="layui-nav-img">
            </a>
        </li>
    </ul>
</nav>

<div id="article" class="layui-container" style="margin-top: 5%; min-height: 100%">
<!--    文章标题与文章信息-->
    <div class="layui-row layui-col-space15">
<!--        标题-->
        <div class="layui-col-md12">
            <div class="layui-panel" id="article-title">
                <h1 style="font-size: 55px;text-align: center">{{ article.articleTitle }}</h1>
            </div>
        </div>
<!--        文章信息-->
        <div class="layui-col-md12">
            <div class="layui-panel" id="article-info" style="font-size: 15px;">
                <span id="article-author">
                    <i class="iconfont">&#xe6b8;</i> {{article.articleAuthorName}}
                </span>
                <span id="article-post-date"><i class="iconfont">&#xe6bb;</i>
                    {{article.articlePostTime.substr(0, 10)}}
                </span>
                <span id="article-view-count"><i class="iconfont">&#xe6e6;</i>
                    {{article.articleViewCount}}
                </span>
                <span id="article-like-count" ><i class="iconfont">&#xe717;</i>
                    {{article.articleLikeCount}}
                </span>
                <span id="article-comment-count"><i class="iconfont">&#xe69b;</i>
                    {{article.articleCommentCount}}
                </span>
            </div>
        </div>
    </div>

<!--    文章主体内容-->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md12">
            <div class="layui-panel" id="article-body" v-html="articleContent">
                {{ articleContent }}
            </div>
        </div>
    </div>

<!--    评论和查看评论   -->
    <div class="layui-row layui-col-space15" id="comment">
<!--        拉取评论之后放在这里-->
        <div class="layui-col-md12 comment-field" v-for="item in commentList">
            <blockquote class="layui-elem-quote layui-quote-nm">
                {{item.commentContent}}
                <div class="comment-info">
                    <span class="comment-info-item">
                        <i class="layui-icon layui-icon-username"></i>
                        {{item.commentAuthorNickname}}
                    </span>
                    <span class="comment-info-item">
                        <i class="layui-icon layui-icon-console"></i>
                        {{item.commentDate | dateFormat}}
                    </span>
                </div>
            </blockquote>
        </div>

        <div class="layui-col-md12 comment-field">
<!--            <form class="layui-form" lay-filter="comment-form">-->
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">昵称</label>
                    <div class="layui-input-inline">
                        <input type="text"
                               name="nickname"
                               v-model="userNickName"
                               autocomplete="off"
                               class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">邮箱</label>
                    <div class="layui-input-inline">
                        <input type="text"
                               name="email"
                               autocomplete="off"
                               class="layui-input"
                               v-model="userEmail"
                               lay-verify="email">
                    </div>
                </div>
                <div class="layui-form-item layui-inline" style="float: right; width: 150px;" >
                    <div class="layui-input-inline">
                        <button type="submit" autocomplete="off" class="layui-btn"
                                style="width: 150px;" @click="submit_comment">
                            提交评论
                        </button>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text" style="margin-top: 15px;">
                    <label class="layui-form-label">内容</label>
                    <div class="layui-input-block">
                        <textarea name="content"
                                  placeholder="请输入内容"
                                  class="layui-textarea"
                        v-model="commentContent">
                        </textarea>
                    </div>
                </div>
<!--            </form>-->
        </div>
    </div>
</div>

<script>

    // layui.use(['element', 'layer'], function(){
    //     var element = layui.element(); //导航的hover效果、二级菜单等功能，需要依赖element模块
    // });

    // 登录之后显示头像和下拉框
    if('[[${session.user}]]' !== ''){
        $("nav img")[1].src = "../images/profile.png"
    }
    // // 提交评论
    // layui.use('form', function () {
    //     form = layui.form;
    //     $ = layui.$;
    //     form.on('submit(submitComment)', function (data) {
    //         // 提交评论的表单
    //         toPost = data.field
    //         toPost['id'] = '[[${#request.getParameter("p")}]]'
    //         $.ajax({
    //             url: "comment/comment",
    //             type: "POST",
    //             data: {
    //                 "id": toPost.id,
    //                 "nickname": toPost.nickname,
    //                 "email": toPost.email,
    //                 "content": toPost.content
    //             },
    //             success: function (result) {
    //                 layer.msg("评论成功");
    //                 // 回调函数，加载新评论
    //                 // 加载评论使用动态加载的方式
    //                 comment = result.extend.comment
    //                 $("#comment-list>div:first-child")
    //                 .prepend($("<blockquote class='layui-elem-quote layui-quote-nm'></blockquote>")
    //                     .append(comment.commentContent)
    //                     .append(
    //                         $("<div class='comment-info'></div>")
    //                             .append(
    //                                 $("<span class='comment-info-item'></span>")
    //                                     .append($("<i class='iconfont'>&#xe6b8;</i>")).append(' ' +
    //                                     comment.commentAuthorNickname)
    //                             ).append(
    //                             $("<span class='comment-info-item'></span>")
    //                                 .append($("<i class='iconfont'>&#xe6bb;</i>")).append(' ' +
    //                                 dateFormat(comment.commentDate))
    //                         )
    //                     ))
    //                 // 清空表单
    //                 form.val("comment-form", {
    //                     "nickname": ""
    //                     ,"email": ""
    //                     ,"content": ""
    //                 });
    //             }
    //         })
    //         return false;
    //     })
    // })




</script>
</body>

<script>
    var Article = new Vue({
        el:"#article",
        data:{
            // 评论列表
            commentList: [],
            // 文章信息对象
            article: {
                articleId: "",
                articleTitle: "Title",
                articlePostTime: "1970-01-01"
            },
            // 文章内容
            articleContent: "",
            // 分页数据
            pagination: {
                // 当前页数
                currentPage: 1,
                // 数据总数
                total: 1,
                // 一页的大小
                size: 10
            },
            postComment:{
                id:'[[${#request.getParameter("p")}]]',
                commentContent: "",
                userEmail: "",
                userNickName: ""
            }
        },
        mounted: function () {
            this.$nextTick(function () {
                this.get_comment_list(1)
                this.get_article_content()
            })
        },
        filters:{
            dateFormat(date) {
                var s = new Date(date)
                var y = s.getFullYear()
                var m = (s.getMonth() + 1) < 10 ? '0' + (s.getMonth() + 1) : (s.getMonth() + 1)
                var dd = s.getDate() < 10 ? '0' + s.getDate() : s.getDate()
                var enddate = y + '-' + m + '-' + dd
                return enddate
            }
        },
        methods: {
            get_comment_list(pn){
                var _this = this
                axios.get('/comment/article',{
                    params: {
                        id: '[[${#request.getParameter("p")}]]',
                        pn: pn
                    }
                }).then(function (response) {
                    // 分页结果
                    let pageInfo = response.data.extend.pageInfo
                    // 评论内容
                    _this.commentList = pageInfo.records
                    // 分页数据
                    _this.pagination.currentPage = pageInfo.current
                    _this.pagination.total = pageInfo.total
                }).catch(function (error) {
                    layer.msg("网络错误，稍后重试")
                    console.log(error)
                });
            },
            get_article_content(){
                var _this = this
                axios.get('/content/' + '[[${#request.getParameter("p")}]]',{})
                    .then(function (response) {
                        // 分页结果
                        _this.article = response.data.extend.article
                        _this.articleContent = response.data.extend.content
                    }).catch(function (error) {
                    layer.msg("网络错误，稍后重试")
                    console.log(error)
                });
            },
            submit_comment(){
                var _this = this
                axios({
                    method: 'post',
                    url: 'comment/post',
                    data: _this.postComment
                }).then(function (response) {
                    layui.layer.msg("评论成功");
                    // 清空表单内容
                    _this.commentContent = ""
                    _this.userNickName = ""
                    _this.userEmail = ""
                }, function (error) {
                    console.log(error)
                })
            }
        }
    })

    // 增加浏览量的函数
    function add_view_count(id){
        $.ajax({url: "/article/view",type: "POST",data: "id="+id,
            success: function (){}
        })
    }

    function add_like_count(id) {
        $.ajax({url: "/article/like",type: "POST",data: "id="+id,
            success: function (){
                $("#article-like-count>i").css("color", "red")
            }
        })
    }
</script>
</html>