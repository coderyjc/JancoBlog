<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/lib/editor.md/editormd.js}"></script>
    <script th:src="@{/lib/layui/layui.js}"></script>
    <link rel="stylesheet" th:href="@{/lib/editor.md/css/editormd.css}">
    <link rel="stylesheet" th:href="@{/lib/layui/css/layui.css}">
    <link rel="stylesheet" th:href="@{/css/font.css}">
    <link rel="stylesheet" th:href="@{/css/article.css}">
    <title></title>
</head>
<body>
<!--导航栏-->
<nav class="clearfix">
    <ul id="top-nav-bar" class="layui-nav layui-bg-black" layui-filter="top-nav">
        <li class="layui-nav-item layui-this">
            <a href="">首页</a>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">计算机基础<i
                    class="layui-icon layui-icon-down layui-nav-more"></i></a>
            <dl class="layui-nav-child">
                <dd><a target="_blank" href="sort.html?type=6">数据结构</a></dd>
                <dd><a target="_blank" href="sort.html?type=8">计算机网络</a></dd>
                <dd><a target="_blank" href="sort.html?type=7">计算机组成原理</a></dd>
            </dl>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">前端<i
                    class="layui-icon layui-icon-down layui-nav-more"></i></a>
            <dl class="layui-nav-child">
                <dd><a target="_blank" href="sort.html?type=22">HTML</a></dd>
                <dd><a target="_blank" href="sort.html?type=23">CSS</a></dd>
                <dd><a target="_blank" href="sort.html?type=24">JavaScript</a></dd>
            </dl>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">Java后端<i
                    class="layui-icon layui-icon-down layui-nav-more"></i></a>
            <dl class="layui-nav-child">
                <dd><a target="_blank" href="sort.html?type=11">Spring</a></dd>
                <dd><a target="_blank" href="sort.html?type=12">SpringMVC</a></dd>
                <dd><a target="_blank" href="sort.html?type=13">MyBatis</a></dd>
                <dd><a target="_blank" href="sort.html?type=14">SpringBoot</a></dd>
            </dl>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">数据库<i class="layui-icon layui-icon-down layui-nav-more"></i></a>
            <dl class="layui-nav-child">
                <dd><a target="_blank" href="sort.html?type=18">MySQL</a></dd>
            </dl>
        </li>
        <li class="layui-nav-item">
            <a href="javascript:;">大数据<i class="layui-icon layui-icon-down layui-nav-more"></i></a>
            <dl class="layui-nav-child">
                <dd><a target="_blank" href="sort.html?type=28">Storm</a></dd>
                <dd><a target="_blank" href="sort.html?type=29">HDFS</a></dd>
            </dl>
        </li>
        <li id="user-profile" class="layui-nav-item" lay-unselect="">
            <a th:href="@{/workbench}">
                <img th:src="@{/images/login-profile.png}" class="layui-nav-img">
            </a>
        </li>
    </ul>
</nav>

<div style="padding: 30px;">

<!--    文章标题与文章信息-->
    <div class="layui-row layui-col-space15" style="margin-top: 4%;">
        <div class="layui-col-md8" style="margin-left: 15%">
            <div class="layui-panel" id="article-title"><h1 style="font-size: 55px;"></h1></div>
        </div>
        <div class="layui-col-md8" style="margin-left: 15%">
            <div class="layui-panel" id="article-info" style="font-size: 15px;">
                <span id="article-author"><i class="iconfont">&#xe6b8;</i> </span>
                <span id="article-post-date"><i class="iconfont">&#xe6bb;</i> </span>
                <span id="article-view-count"><i class="iconfont">&#xe6e6;</i> </span>
                <span id="article-like-count"><i class="iconfont">&#xe717;</i> </span>
                <span id="article-comment-count"><i class="iconfont">&#xe69b;</i> </span>
            </div>
        </div>
    </div>

<!--    文章主体内容-->
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md8" style="margin-left: 15%">
            <div class="layui-panel" id="article-body">
            </div>
        </div>
    </div>

<!--    评论和查看评论   -->
    <div class="layui-row layui-col-space15" id="comment-list">
<!--        拉取评论之后放在这里-->
        <div class="layui-col-md8 comment-field" style="margin-left: 15%">
            <form class="layui-form" lay-filter="comment-form">
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">昵称</label>
                    <div class="layui-input-inline">
                        <input type="text" name="nickname" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item layui-inline">
                    <label class="layui-form-label">邮箱</label>
                    <div class="layui-input-inline">
                        <input type="text" name="email" autocomplete="off" class="layui-input"
                               lay-verify="email">
                    </div>
                </div>
                <div class="layui-form-item layui-inline" style="float: right; width: 150px;" >
                    <div class="layui-input-inline">
                        <input type="submit" autocomplete="off" class="layui-btn"
                               style="width: 150px;" value="提交评论" lay-submit
                               lay-filter="submitComment">
                    </div>
                </div>
                <div class="layui-form-item layui-form-text" style="margin-top: 15px;">
                    <label class="layui-form-label">内容</label>
                    <div class="layui-input-block">
                        <textarea name="content" placeholder="请输入内容"
                                  class="layui-textarea"></textarea>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<script>

    // 登录之后显示头像和下拉框
    if('[[${session.user}]]' !== ''){
        $("nav img").attr("src", "../images/profile.png")
    }

    layui.use(['element', 'layer'], function(){
        var element = layui.element(); //导航的hover效果、二级菜单等功能，需要依赖element模块
    });

    // 拿到文章内容
    $.ajax({
        url: "/content/" + '[[${#request.getParameter("p")}]]',
        type: "GET",
        success: function (result) {
            article = result.extend.article
            $("#article-body").append(result.extend.content)
            $("title").text(article.articleTitle)
            $("#article-title>h1").text(article.articleTitle)
            $("#article-author").append(article.articleAuthorName);
            $("#article-post-date").append(article.articlePostTime.substr(0, 10))
            $("#article-view-count").append(article.articleViewCount)
            $("#article-like-count").append(article.articleLikeCount)
            $("#article-comment-count").append(article.articleCommentCount)
        }
    })

    // 拿到评论内容
    $.ajax({
        url: "/comment/article",
        type: "GET",
        data: {
            "id": '[[${#request.getParameter("p")}]]'
        },
        success: function (result){
            var list = result.extend.pageInfo
            var parent =
            $("<div class='layui-col-md8 comment-field' style='margin-left: 15%'></div>");
            $.each(list, function (index, item) {
                parent.append(
                    $("<blockquote class='layui-elem-quote layui-quote-nm'></blockquote>")
                    .append(item.commentContent)
                    .append(
                        $("<div class='comment-info'></div>")
                            .append(
                                $("<span class='comment-info-item'></span>")
                                    .append($("<i class='iconfont'>&#xe6b8;</i>")).append(' ' +
                                    item.commentAuthorNickname)
                            ).append(
                            $("<span class='comment-info-item'></span>")
                                .append($("<i class='iconfont'>&#xe6bb;</i>")).append(' ' +
                                dateFormat(item.commentDate))
                        )
                    )
                )
            })
            $("#comment-list").prepend(parent)
        }
    })

    // 提交评论
    layui.use('form', function () {
        form = layui.form;
        $ = layui.$;
        form.on('submit(submitComment)', function (data) {
            // 提交评论的表单
            toPost = data.field
            toPost['id'] = '[[${#request.getParameter("p")}]]'
            $.ajax({
                url: "comment/comment",
                type: "POST",
                data: {
                    "id": toPost.id,
                    "nickname": toPost.nickname,
                    "email": toPost.email,
                    "content": toPost.content
                },
                success: function (result) {
                    layer.msg("评论成功");
                    // 回调函数，加载新评论
                    comment = result.extend.comment
                    $("#comment-list>div:first-child")
                    .prepend($("<blockquote class='layui-elem-quote layui-quote-nm'></blockquote>")
                        .append(comment.commentContent)
                        .append(
                            $("<div class='comment-info'></div>")
                                .append(
                                    $("<span class='comment-info-item'></span>")
                                        .append($("<i class='iconfont'>&#xe6b8;</i>")).append(' ' +
                                        comment.commentAuthorNickname)
                                ).append(
                                $("<span class='comment-info-item'></span>")
                                    .append($("<i class='iconfont'>&#xe6bb;</i>")).append(' ' +
                                    dateFormat(comment.commentDate))
                            )
                        ))
                    // 清空表单
                    form.val("comment-form", {
                        "nickname": ""
                        ,"email": ""
                        ,"content": ""
                    });
                }
            })
            return false;
        })
    })


    /**
     * 将时间戳转化为标准时间
     * @param date 时间戳
     * @returns {string} 标准时间字符串
     */
    function dateFormat(date) {
        var s = new Date(date)
        var y = s.getFullYear()
        var m = (s.getMonth() + 1) < 10 ? '0' + (s.getMonth() + 1) : (s.getMonth() + 1)
        var dd = s.getDate() < 10 ? '0' + s.getDate() : s.getDate()
        var enddate = y + '-' + m + '-' + dd
        return enddate
    }
</script>
</body>

</html>